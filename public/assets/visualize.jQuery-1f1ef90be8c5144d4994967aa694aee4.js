/*
 * --------------------------------------------------------------------
 * jQuery inputToButton plugin
 * Author: Scott Jehl, scott@filamentgroup.com
 * Copyright (c) 2009 Filament Group 
 * licensed under MIT (filamentgroup.com/examples/mit-license.txt)
 * --------------------------------------------------------------------
*/
!function(t){t.fn.visualize=function(e,i){return t(this).each(function(){function n(){var e=s.colors,i=s.textColors,n={dataGroups:function(){var n=[];if("x"==s.parseDirection)a.find("tr:gt(0)").filter(s.rowFilter).each(function(a){n[a]={},n[a].points=[],n[a].color=e[a],i[a]&&(n[a].textColor=i[a]),t(this).find("td").filter(s.colFilter).each(function(){n[a].points.push(parseFloat(t(this).text()))})});else for(var o=a.find("tr:eq(1) td").filter(s.colFilter).size(),r=0;o>r;r++)n[r]={},n[r].points=[],n[r].color=e[r],i[r]&&(n[r].textColor=i[r]),a.find("tr:gt(0)").filter(s.rowFilter).each(function(){n[r].points.push(1*t(this).find("td").filter(s.colFilter).eq(r).text())});return n},allData:function(){var e=[];return t(this.dataGroups()).each(function(){e.push(this.points)}),e},dataSum:function(){var e=0,i=this.allData().join(",").split(",");return t(i).each(function(){e+=parseFloat(this)}),e},topValue:function(){var e=0,i=this.allData().join(",").split(",");return t(i).each(function(){parseFloat(this,10)>e&&(e=parseFloat(this))}),e},bottomValue:function(){var e=0,i=this.allData().join(",").split(",");return t(i).each(function(){e>this&&(e=parseFloat(this))}),e},memberTotals:function(){var e=[],i=this.dataGroups();return t(i).each(function(n){var s=0;t(i[n].points).each(function(t){s+=i[n].points[t]}),e.push(s)}),e},yTotals:function(){for(var e=[],i=this.dataGroups(),n=this.xLabels().length,s=0;n>s;s++){e[s]=[];var a=0;t(i).each(function(){e[s].push(this.points[s])}),e[s].join(",").split(","),t(e[s]).each(function(){a+=parseFloat(this)}),e[s]=a}return e},topYtotal:function(){var e=0,i=this.yTotals().join(",").split(",");return t(i).each(function(){parseFloat(this,10)>e&&(e=parseFloat(this))}),e},totalYRange:function(){return this.topValue()-this.bottomValue()},xLabels:function(){var e=[];return"x"==s.parseDirection?a.find("tr:eq(0) th").filter(s.colFilter).each(function(){e.push(t(this).html())}):a.find("tr:gt(0) th").filter(s.rowFilter).each(function(){e.push(t(this).html())}),e},yLabels:function(){var t=[];t.push(g);for(var e=Math.round(s.height/s.yLabelInterval),i=Math.ceil(_/e)||1;t[t.length-1]<p-i;)t.push(t[t.length-1]+i);return t.push(p),t}};return n}var s=t.extend({type:"bar",width:t(this).width(),height:t(this).height(),appendTitle:!0,title:null,appendKey:!0,rowFilter:"*",colFilter:"*",colors:["#be1e2d","#666699","#92d5ea","#ee8310","#8d10ee","#5a3b16","#26a4ed","#f45a90","#e9e744"],textColors:[],parseDirection:"x",pieMargin:20,pieLabelsAsPercent:!0,pieLabelPos:"inside",lineWeight:4,barGroupMargin:10,barMargin:1,yLabelInterval:30},e);s.width=parseFloat(s.width),s.height=parseFloat(s.height);var a=t(this),o={pie:function(){u.addClass("visualize-pie"),"outside"==s.pieLabelPos&&u.addClass("visualize-pie-outside");var e=Math.round(l.width()/2),i=Math.round(l.height()/2),n=i-s.pieMargin,a=0,o=t('<ul class="visualize-labels"></ul>').insertAfter(l);t.each(m,function(r){var l=0>=this||isNaN(this)?0:this/f;T.beginPath(),T.moveTo(e,i),T.arc(e,i,n,2*a*Math.PI-.5*Math.PI,2*(a+l)*Math.PI-.5*Math.PI,!1),T.lineTo(e,i),T.closePath(),T.fillStyle=d[r].color,T.fill();var h=a+l/2,u="inside"==s.pieLabelPos?n/1.5:n+n/5,c=Math.round(e+Math.sin(2*h*Math.PI)*u),p=Math.round(i-Math.cos(2*h*Math.PI)*u),g=c>e?"right":"left",m=p>i?"bottom":"top",_=parseFloat((100*l).toFixed(2));if(_){var v=s.pieLabelsAsPercent?_+"%":this,y=t('<span class="visualize-label">'+v+"</span>").css(g,0).css(m,0);y&&t('<li class="visualize-label-pos"></li>').appendTo(o).css({left:c,top:p}).append(y),y.css("font-size",n/8).css("margin-"+g,-y.width()/2).css("margin-"+m,-y.outerHeight()/2),d[r].textColor&&y.css("color",d[r].textColor)}a+=l})},line:function(e){e?u.addClass("visualize-area"):u.addClass("visualize-line");var i=l.width()/(y.length-1),n=t('<ul class="visualize-labels-x"></ul>').width(l.width()).height(l.height()).insertBefore(l);t.each(y,function(e){var s=t("<li><span>"+this+"</span></li>").prepend('<span class="line" />').css("left",i*e).appendTo(n),a=s.find("span:not(.line)"),o=a.width()/-2;0==e?o=0:e==y.length-1&&(o=-a.width()),a.css("margin-left",o).addClass("label")});var a=l.height()/_,o=l.height()/(b.length-1),r=t('<ul class="visualize-labels-y"></ul>').width(l.width()).height(l.height()).insertBefore(l);t.each(b,function(e){var i=t("<li><span>"+this+"</span></li>").prepend('<span class="line"  />').css("bottom",o*e).prependTo(r),n=i.find("span:not(.line)"),s=n.height()/-2;0==e?s=-n.height():e==b.length-1&&(s=0),n.css("margin-top",s).addClass("label")}),T.translate(0,v),t.each(d,function(){T.beginPath(),T.lineWidth=s.lineWeight,T.lineJoin="round";var n=this.points,o=0;T.moveTo(0,-(n[0]*a)),t.each(n,function(){T.lineTo(o,-(this*a)),o+=i}),T.strokeStyle=this.color,T.stroke(),e?(T.lineTo(o,0),T.lineTo(0,0),T.closePath(),T.fillStyle=this.color,T.globalAlpha=.3,T.fill(),T.globalAlpha=1):T.closePath()})},area:function(){o.line(!0)},bar:function(){u.addClass("visualize-bar");var e=l.width()/y.length,i=t('<ul class="visualize-labels-x"></ul>').width(l.width()).height(l.height()).insertBefore(l);t.each(y,function(n){var s=t('<li><span class="label">'+this+"</span></li>").prepend('<span class="line" />').css("left",e*n).width(e).appendTo(i),a=s.find("span.label");a.addClass("label")});var n=l.height()/_,a=l.height()/(b.length-1),o=t('<ul class="visualize-labels-y"></ul>').width(l.width()).height(l.height()).insertBefore(l);t.each(b,function(e){var i=t("<li><span>"+this+"</span></li>").prepend('<span class="line"  />').css("bottom",a*e).prependTo(o),n=i.find("span:not(.line)"),s=n.height()/-2;0==e?s=-n.height():e==b.length-1&&(s=0),n.css("margin-top",s).addClass("label")}),T.translate(0,v);for(var r=0;r<d.length;r++){T.beginPath();var h=(e-2*s.barGroupMargin)/d.length,c=h-2*s.barMargin;T.lineWidth=c;for(var f=d[r].points,p=0,g=0;g<f.length;g++){var m=p-s.barGroupMargin+r*h+h/2;m+=2*s.barGroupMargin,T.moveTo(m,0),T.lineTo(m,Math.round(-f[g]*n)),p+=e}T.strokeStyle=d[r].color,T.stroke(),T.closePath()}}},r=document.createElement("canvas");r.setAttribute("height",s.height),r.setAttribute("width",s.width);var l=t(r),h=s.title||a.find("caption").text(),u=(i||t('<div class="visualize" role="img" aria-label="Chart representing data from the table: '+h+'" />')).height(s.height).width(s.width).append(l),c=n(),d=c.dataGroups();c.allData();var f=c.dataSum(),p=c.topValue(),g=c.bottomValue(),m=c.memberTotals(),_=c.totalYRange(),v=s.height*(p/_),y=c.xLabels(),b=c.yLabels();if(s.appendTitle||s.appendKey)var w=t('<div class="visualize-info"></div>').appendTo(u);if(s.appendTitle&&t('<div class="visualize-title">'+h+"</div>").appendTo(w),s.appendKey){var x,S=t('<ul class="visualize-key"></ul>');x="x"==s.parseDirection?a.find("tr:gt(0) th").filter(s.rowFilter):a.find("tr:eq(0) th").filter(s.colFilter),x.each(function(e){t('<li><span class="visualize-key-color" style="background: '+d[e].color+'"></span><span class="visualize-key-label">'+t(this).text()+"</span></li>").appendTo(S)}),S.appendTo(w)}i||u.insertAfter(this),"undefined"!=typeof G_vmlCanvasManager&&(G_vmlCanvasManager.init(),G_vmlCanvasManager.initElement(l[0]));var T=l[0].getContext("2d");o[s.type](),t(".visualize-line li:first-child span.line, .visualize-line li:last-child span.line, .visualize-area li:first-child span.line, .visualize-area li:last-child span.line, .visualize-bar li:first-child span.line,.visualize-bar .visualize-labels-y li:last-child span.line").css("border","none"),i||u.bind("visualizeRefresh",function(){a.visualize(s,t(this).empty())})}).next()}}(jQuery);